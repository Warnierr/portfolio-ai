generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ANALYTICS & DATA COLLECTION (RGPD 2026)
// ========================================

/// Session de chat anonyme (sans données personnelles)
model ChatSession {
  id           String   @id @default(cuid())
  sessionId    String   @unique
  profile      String?  // "recruiter" | "dev" | "founder" | "association" | "curious"
  createdAt    DateTime @default(now())
  endedAt      DateTime?
  duration     Int?     // durée en secondes
  messageCount Int      @default(0)
  
  // Relations
  messages     ChatMessage[]
  consents     ConsentLog[]
  
  // Métadonnées analytics (anonymes)
  referrer     String?  // d'où vient l'user
  userAgent    String?  // navigateur
  
  @@index([createdAt])
  @@index([profile])
}

/// Message de conversation (stocké uniquement si consentement)
model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // "user" | "assistant"
  content   String?  @db.Text // NULL si pas de consentement
  category  String?  // "technical" | "commercial" | "availability" | "general"
  timestamp DateTime @default(now())
  
  // Relations
  session   ChatSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([category])
}

/// Log de consentement RGPD
model ConsentLog {
  id        String   @id @default(uuid())
  sessionId String
  granted   Boolean  // true = opt-in, false = opt-out
  level     String   // "session" | "persistent" | "none"
  timestamp DateTime @default(now())
  
  // Relations
  session   ChatSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  
  @@index([sessionId])
}

// ========================================
// LEADS & CONTACTS
// ========================================

/// Lead généré (formulaire ou chat)
model Lead {
  id        String   @id @default(uuid())
  email     String
  name      String?
  company   String?
  message   String?  @db.Text
  source    String   // "chat" | "contact_form" | "service_page"
  profile   String?  // Type de profil
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@index([source])
}

// ========================================
// ANALYTICS GLOBALES
// ========================================

/// Page views et événements
model Analytics {
  id        String   @id @default(uuid())
  page      String
  event     String?  // "page_view" | "cta_click" | "theme_change", etc.
  metadata  Json?    // Données supplémentaires
  userAgent String?
  referrer  String?
  createdAt DateTime @default(now())
  
  @@index([page])
  @@index([createdAt])
}
